---
apic:
  access_policies:
    interface_policies:
      cdp_policies:
        - name: My-vCenter_cdpIfPol
          admin_state: true
      lldp_policies:
        - name: My-vCenter_lldpIfPol
          admin_rx_state: true
          admin_tx_state: true
      port_channel_policies:
        - name: My-vCenter_lacpLagPol
          mode: mac-pin
    vlan_pools:
      - name: vcenter-vlans
        description: "VLANs used by Vcenter VMM integration"
        allocation: dynamic
        ranges:
          - from: 3000
            to: 3050

  fabric_policies:
    vmware_vmm_domains:
    - name: My-vCenter
      access_mode: read-write
      vlan_pool: vcenter-vlans
      vswitch:
        cdp_policy: My-vCenter_cdpIfPol
        lldp_policy: My-vCenter_lldpIfPol
        port_channel_policy: My-vCenter_lacpLagPol
      credential_policies:
        - name: vCenterUser
          username: administrator
          password: C1sco12345
      vcenters:
        - name: vc1
          hostname_ip: 198.18.133.30
          datacenter: dCloud-DC
          credential_policy: vCenterUser
          dvs_version: 6.6
  tenants:
    - name: NaC_L4L7_SVC

      vrfs:
        - name: production

      bridge_domains: 
        - name: 192.168.10.0
          vrf: production
          subnets: 
          - ip: 192.168.10.254/24 
        - name: 192.168.20.0
          vrf: production
          subnets: 
          - ip: 192.168.20.254/24 
        - name: fw-client
          vrf: production
          subnets: 
          - ip: 172.16.10.254/24
        - name: fw-server
          vrf: production
          subnets: 
          - ip: 172.16.20.254/24


      application_profiles:
        - name: segments
          endpoint_groups:
            - name: client
              bridge_domain: 192.168.10.0
              contracts:
                consumers:
                  - web-db
              vmware_vmm_domains:
                - name: My-vCenter
                  delimiter: '|'
                  deployment_immediacy: immediate
                  resolution_immediacy: immediate
            - name: server
              bridge_domain: 192.168.20.0
              contracts:
                providers:
                  - web-db
              vmware_vmm_domains:
                - name: My-vCenter
                  delimiter: '|'
                  deployment_immediacy: immediate
                  resolution_immediacy: immediate

      filters:
        - name: icmp
          entries:
            - name: icmp
              ethertype: ip
              protocol: icmp
        - name: web
          entries:
            - name: http
              ethertype: ip
              protocol: tcp
              destination_from_port: http
              destination_to_port: http

      contracts:
        - name: web-db
          subjects:
            - name: icmp
              filters:
                - filter: icmp
              service_graph: asa-routed
            - name: web
              filters:
                - filter: web
      
      services:
        l4l7_devices:
          - name: asav
            context_aware: single-Context
            type: VIRTUAL
            vmware_vmm_domain: My-vCenter 
            function: GoTo
            managed: false
            service_type: FW
            concrete_devices:
              - name: asav
                vcenter_name: vc1 
                vm_name: ASAv 
                interfaces:
                  - name: client
                    vnic_name: Network adapter 2
                  - name: server
                    vnic_name: Network adapter 3
            logical_interfaces:
              - name: client
                concrete_interfaces:
                  - device: asav
                    interface_name: client
              - name: server
                concrete_interfaces:
                  - device: asav
                    interface_name: server
        redirect_policies:
          - name: client
            l3_destinations:
              - ip: 172.16.10.1
                mac: 00:50:56:8E:F7:96 # CHANGE THIS TO MAC OF ASAV NETWORK ADAPTER 2
          - name: server
            l3_destinations:
              - ip: 172.16.20.1
                mac: 00:50:56:8E:51:93 # CHANGE THIS TO MAC OF ASAV NETWORK ADAPTER 3 
        service_graph_templates:
          - name: asa-routed
            template_type: FW_ROUTED
            redirect: true
            device:
              tenant: NaC_L4L7_SVC
              name: asav
        device_selection_policies:
          - contract: web-db
            service_graph_template: asa-routed
            consumer:
              l3_destination: true
              redirect_policy:
                name: client
              logical_interface: client
              bridge_domain:
                name: fw-client
            provider:
              l3_destination: true
              redirect_policy:
                name: server
              logical_interface: server
              bridge_domain:
                name: fw-server